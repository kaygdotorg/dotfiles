# Standalone tmux configuration ‚Äî Catppuccin Mocha pill theme
#
# Replaces oh-my-tmux framework. All settings are direct tmux commands.
#
# CATPPUCCIN MOCHA PALETTE
#   Base     #1e1e2e   Mantle   #181825   Crust    #11111b
#   Surface0 #313244   Surface1 #45475a   Surface2 #585b70
#   Overlay0 #6c7086   Overlay1 #7f849c   Overlay2 #9399b2
#   Text     #cdd6f4   Subtext1 #bac2de   Subtext0 #a6adc8
#   Mauve    #cba6f7   Blue     #89b4fa   Lavender #b4befe
#   Yellow   #f9e2af   Peach    #fab387   Red      #f38ba8
#   Green    #a6e3a1   Teal     #94e2d5   Sky      #89dceb
#
# FONT: Cascadia Code NF (Nerd Font)
#   Pill caps use Powerline Extra glyphs E0B6 (left) / E0B4 (right)
#   as literal UTF-8 characters below.


# -- options -------------------------------------------------------------------

set -g history-limit 50000
set -g mouse on
set -g focus-events on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g set-titles on
set -g set-titles-string '#h ‚óÜ #S ‚óè #I #W'


# -- terminal ------------------------------------------------------------------

set -g default-terminal "tmux-256color"

# set -g resets the list; subsequent -ga appends. On reload, -g resets again.
set  -g  terminal-features "xterm*:clipboard:ccolour:cstyle:focus:title"
set -ga  terminal-features ",screen*:title"
set -ga  terminal-features ",rxvt*:ignorefkeys"
set -ga  terminal-features ",xterm-256color:RGB"
set -ga  terminal-features ",tmux-256color:clipboard"

# NOTE: extended-keys (kitty keyboard protocol) is intentionally NOT enabled.
# `set -s extended-keys always` would allow Shift+Enter etc. to pass through
# to apps like Claude Code, but it causes breakage:
#   - Shift+Tab sends raw escape codes instead of working (tmux#4304)
#   - Pasting in neovim produces artifacts (gpakosz/.tmux#776)
#   - Fish shell completions break in tmux 3.5+ (tmux#2705)
# The safer `on` mode only sends extended keys when apps opt in, but Claude
# Code doesn't opt in. Use backslash+Enter for newlines in Claude Code instead.


# -- clipboard ----------------------------------------------------------------
#
# OSC 52 clipboard chain for nested tmux (inner SSH ‚Üí outer Mac ‚Üí iTerm2):
#
#   App (e.g. vim) emits OSC 52
#     ‚Üí inner tmux intercepts (set-clipboard on) and re-emits to its terminal
#       ‚Üí SSH forwards the bytes
#         ‚Üí outer tmux intercepts (set-clipboard on) and re-emits to iTerm2
#           ‚Üí iTerm2 sets macOS clipboard
#
# set-clipboard on : intercept + re-emit OSC 52 from applications (path above)
# allow-passthrough : permit DCS passthrough sequences from apps inside tmux
#
# NOTE: set-clipboard on handles APP-originated OSC 52 reliably, but does NOT
# emit OSC 52 from tmux's own copy mode when nested (TERM=tmux-256color).
# Copy-mode bindings below work around this with explicit OSC 52 via copy-pipe.

set -g set-clipboard on
set -g allow-passthrough on


# -- prefix --------------------------------------------------------------------

set -g prefix C-t
set -g prefix2 None
bind -N "Send prefix to inner session" C-t send-prefix


# -- key bindings --------------------------------------------------------------

# pane navigation (vim-style)
bind -N "Select pane left"  h select-pane -L
bind -N "Select pane down"  j select-pane -D
bind -N "Select pane up"    k select-pane -U
bind -N "Select pane right" l select-pane -R

# pane resizing
bind -N "Resize pane left by 2"  -r H resize-pane -L 2
bind -N "Resize pane down by 2"  -r J resize-pane -D 2
bind -N "Resize pane up by 2"    -r K resize-pane -U 2
bind -N "Resize pane right by 2" -r L resize-pane -R 2

# split panes with current path
bind -N "Split pane horizontally" - split-window -v -c "#{pane_current_path}"
bind -N "Split pane vertically"   _ split-window -h -c "#{pane_current_path}"

# swap windows
bind -N "Swap window left"  -r < swap-window -d -t -1
bind -N "Swap window right" -r > swap-window -d -t +1

# last window
bind -N "Select last window" Tab last-window

# new session prompt
bind -N "Create a new session" C-c command-prompt -p "new session:" "new-session -s '%%'"

# reload config
bind -N "Reload tmux configuration" r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded"

# -- nested session passthrough ------------------------------------------------
# F12 toggles pass-through mode for nested tmux (outer Mac + inner SSH).
# When active, all keys go directly to the inner tmux ‚Äî the outer prefix,
# bindings, and copy mode are completely bypassed. Only F12 itself remains
# bound (in the "off" key table) to toggle back. A red pill appears in the
# status bar when pass-through is active.

bind -N "Toggle nested pass-through mode" -T root F12 \
  set prefix None \;\
  set key-table off \;\
  refresh-client -S

bind -N "Toggle nested pass-through mode" -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  refresh-client -S

# toggle mouse
bind -N "Toggle mouse on/off" m set -g mouse \; display "mouse #{?mouse,on,off}"

# enter copy mode
bind -N "Enter copy mode" Enter copy-mode

# browse paste buffers ‚Üí view selected in a split pane
#   Opens a horizontal split showing the buffer in less. The pane is
#   resizable (prefix + H/J/K/L) and closable (prefix + x or just q).
bind -N "View a paste buffer in split" b choose-buffer -Z "split-window -v -l 40% 'tmux show-buffer -b \"%%\" | less'"

# cheatsheet popup (prefix + ?)
#   Merges list-keys -N descriptions (human-readable notes set via bind -N)
#   with the full list-keys output so every binding appears ‚Äî including
#   plugin bindings that lack -N notes. The awk scripts:
#     1. Build a lookup of key‚Üídescription from  list-keys -N  (clean output)
#     2. Walk the full  list-keys  output for ALL bindings
#     3. For each key, use the -N description if available; otherwise
#        humanize the raw command (strip send-keys -X, capitalize, etc.)
#   Piped through less for scrolling (arrows/j/k) and searching (/).
#   Mouse bindings are filtered from root table (default behaviour, not useful).
#   Uses POSIX-compatible  dd  instead of  read -n1  so it works under dash.
bind -N "Show key bindings cheatsheet" ? display-popup -w 80% -h 80% -E -T " Keybindings  (/ search, q quit) " '\
  { printf "\033[1;35m‚îÄ‚îÄ Prefix Bindings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m\n";\
    tmux list-keys -T prefix | awk '"'"'BEGIN{while(("tmux list-keys -N -T prefix"|getline l)>0){split(l,a," ");k=a[1];sub(/^[^ ]+ +/,"",l);desc[k]=l}}{sub(/^bind-key +/,"");sub(/-r +/,"");sub(/-T +[^ ]+ +/,"");k=$1;sub(/^[^ ]+ +/,"");nk=k;gsub(/\\/,"",nk);if(nk in desc)d=desc[nk];else{d=$0;if(d~/tmux-fingers.*jump/)d="Hint-jump mode (tmux-fingers)";else if(d~/tmux-fingers/)d="Hint-copy patterns (tmux-fingers)";else if(d~/\/tpm\//)d="TPM plugin manager";else if(length(d)>55)d=substr(d,1,52)"..."};printf "  C-t %-12s %s\n",nk,d}'"'"';\
    printf "\n";\
    printf "\033[1;35m‚îÄ‚îÄ Root Bindings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m\n";\
    tmux list-keys -T root | awk '"'"'BEGIN{while(("tmux list-keys -N -T root"|getline l)>0){split(l,a," ");k=a[1];sub(/^[^ ]+ +/,"",l);desc[k]=l}}{sub(/^bind-key +/,"");sub(/-r +/,"");sub(/-T +[^ ]+ +/,"");k=$1;sub(/^[^ ]+ +/,"");nk=k;gsub(/\\/,"",nk);if(nk~/^Mouse|^Wheel|^Double|^Triple|^M-Mouse/)next;if(nk in desc)d=desc[nk];else{d=$0;if(length(d)>55)d=substr(d,1,52)"..."};printf "  %-16s %s\n",nk,d}'"'"';\
    printf "\n";\
    printf "\033[1;35m‚îÄ‚îÄ Copy Mode (vi) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m\n";\
    tmux list-keys -T copy-mode-vi | awk '"'"'BEGIN{while(("tmux list-keys -N -T copy-mode-vi"|getline l)>0){split(l,a," ");k=a[1];sub(/^[^ ]+ +/,"",l);desc[k]=l}}{sub(/^bind-key +/,"");sub(/-r +/,"");sub(/-T +[^ ]+ +/,"");k=$1;sub(/^[^ ]+ +/,"");nk=k;gsub(/\\/,"",nk);if(nk in desc)d=desc[nk];else{d=$0;if(d~/^send-keys -F?X /){sub(/^send-keys -F?X /,"",d);sub(/ .*/,"",d);if(d=="copy-pipe-and-cancel")d="Copy selection and exit";else if(d=="copy-pipe-end-of-line-and-cancel")d="Copy to end of line and exit";else if(d=="append-selection-and-cancel")d="Append to selection and exit";else{gsub(/-/," ",d);d=toupper(substr(d,1,1))substr(d,2)}}else if(d~/command-prompt/&&match(d,/\([^)]+\)/)){d=substr(d,RSTART+1,RLENGTH-2);d=toupper(substr(d,1,1))substr(d,2);if(d=="Repeat")d="Repeat count prefix"}else if(nk=="MouseDrag1Pane")d="Begin mouse selection";else if(nk=="MouseDragEnd1Pane")d="Copy mouse selection and exit";else if(nk=="MouseDown1Pane")d="Select pane";else if(nk=="WheelUpPane")d="Scroll up";else if(nk=="WheelDownPane")d="Scroll down";else if(nk=="DoubleClick1Pane")d="Select and copy word";else if(nk=="TripleClick1Pane")d="Select and copy line";else if(length(d)>55)d=substr(d,1,52)"..."};printf "  %-16s %s\n",nk,d}'"'"';\
  } | less -R'


# -- copy mode (vi) ------------------------------------------------------------

set -g mode-keys vi

# WORKAROUND: Explicit OSC 52 for nested tmux copy-mode clipboard
#
# Problem: tmux's set-clipboard on correctly intercepts and re-emits OSC 52
# from *applications* (e.g. printf '\e]52;c;...\a'), but does NOT emit OSC 52
# from its own copy mode when running nested (TERM=tmux-256color). This means
# yanking or mouse-selecting in copy mode silently fails to reach the outer
# clipboard. Tested on tmux 3.5a; the Ms terminfo capability, terminal-features
# clipboard flag, and set-clipboard on are all correctly configured ‚Äî yet
# copy-mode still doesn't emit the sequence.
#
# Fix: use copy-pipe-and-cancel with an explicit command that base64-encodes
# the selection and writes an OSC 52 sequence directly to #{client_tty} (the
# terminal the tmux client is attached to, i.e. the SSH PTY). From there, the
# bytes travel through SSH ‚Üí outer tmux (which intercepts via set-clipboard on
# and re-emits) ‚Üí iTerm2 ‚Üí macOS clipboard.

bind -N "Begin selection"              -T copy-mode-vi v send -X begin-selection
bind -N "Toggle rectangle selection"  -T copy-mode-vi C-v send -X rectangle-toggle
bind -N "Yank to clipboard (OSC 52)"  -T copy-mode-vi y send -X copy-pipe-and-cancel 'printf "\033]52;c;%s\a" "$(base64 | tr -d \\n)" > #{client_tty}'
bind -N "Cancel copy mode"            -T copy-mode-vi Escape send -X cancel
bind -N "Start of line"               -T copy-mode-vi H send -X start-of-line
bind -N "End of line"                  -T copy-mode-vi L send -X end-of-line
# Y: yank selection to paste buffer AND open it in a reference split pane.
#   copy-pipe-and-cancel saves to paste buffer + pipes to the OSC 52 clipboard
#   command (so it also reaches the system clipboard), then split-window opens
#   the buffer in less for reference. The split is resizable and closes with q.
bind -N "Yank to reference split"      -T copy-mode-vi Y send -X copy-pipe-and-cancel 'printf "\033]52;c;%s\a" "$(base64 | tr -d \\n)" > #{client_tty}' \; split-window -v -l 40% 'tmux show-buffer | less'

# mouse copy
bind -N "Copy mouse selection (OSC 52)"      -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'printf "\033]52;c;%s\a" "$(base64 | tr -d \\n)" > #{client_tty}'
bind -N "Select and copy word (OSC 52)"      -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word \; run -d 0.3 \; send -X copy-pipe-and-cancel 'printf "\033]52;c;%s\a" "$(base64 | tr -d \\n)" > #{client_tty}'
bind -N "Select and copy line (OSC 52)"      -T copy-mode-vi TripleClick1Pane select-pane \; send -X select-line \; run -d 0.3 \; send -X copy-pipe-and-cancel 'printf "\033]52;c;%s\a" "$(base64 | tr -d \\n)" > #{client_tty}'


# -- appearance ----------------------------------------------------------------

# fat pane borders (bg=fg for solid stripe)
set -g pane-border-style        'fg=#313244,bg=#313244'
set -g pane-active-border-style 'fg=#cba6f7,bg=#cba6f7'
set -g pane-border-indicators   colour

# messages (catppuccin yellow)
set -g message-style            'fg=#1e1e2e,bg=#f9e2af,bold'
set -g message-command-style    'fg=#f9e2af,bg=#1e1e2e,bold'

# copy/search mode
set -g mode-style               'fg=#1e1e2e,bg=#f9e2af,bold'

# clock
set -g clock-mode-colour        '#89b4fa'
set -g clock-mode-style         24


# -- status bar ----------------------------------------------------------------

# transparent background (terminal wallpaper shows through)
set -g status on
set -g status-style 'fg=#cdd6f4,bg=default'

# status left: path pill
#   sed replaces $HOME with ~ for pretty path display
set -g status-left '#[fg=#313244,bg=default]ÓÇ∂#[fg=#cdd6f4,bg=#313244] #(echo "#{pane_current_path}" | sed "s|$HOME|~|") #[fg=#313244,bg=default]ÓÇ¥ '
set -g status-left-length 60

# status right: indicators + session pill + user@host pill
#   #{?#{==:...},..}       pass-through mode (F12 toggle, red pill)
#   #{?client_prefix,...}  replaces oh-my-tmux's #{prefix}
#   #{?session_many_attached,...}  replaces #{pairing}
#   #{?pane_synchronized,...}  replaces #{synchronized}
set -g status-right '#{?#{==:#{client_key_table},off},#[fg=#f38ba8#,bg=default]ÓÇ∂#[fg=#1e1e2e#,bg=#f38ba8#,bold] üîí #[fg=#f38ba8#,bg=default]ÓÇ¥ ,}#{?client_prefix,‚å® , }#{?session_many_attached,üëì , }#{?pane_synchronized,üîí , }#[fg=#cba6f7,bg=default]ÓÇ∂#[fg=#1e1e2e,bg=#cba6f7,bold] ‚óÜ #S #[fg=#cba6f7,bg=default]ÓÇ¥ #[fg=#313244,bg=default]ÓÇ∂#[fg=#cdd6f4,bg=#313244] #(whoami)@#h #[fg=#313244,bg=default]ÓÇ¥ '
set -g status-right-length 90

# window tabs (inactive pill ‚Äî surface2)
setw -g window-status-style 'fg=#585b70,bg=default'
setw -g window-status-format '#[fg=#585b70,bg=default]ÓÇ∂#[fg=#9399b2,bg=#585b70] #I #W #[fg=#585b70,bg=default]ÓÇ¥'

# window tabs (active pill ‚Äî lavender)
setw -g window-status-current-style 'fg=#b4befe,bg=default'
setw -g window-status-current-format '#[fg=#b4befe,bg=default]ÓÇ∂#[fg=#1e1e2e,bg=#b4befe,bold] #I #W #[fg=#b4befe,bg=default]ÓÇ¥'

# window separator (space between pills)
setw -g window-status-separator ' '

# activity / bell
setw -g window-status-activity-style 'fg=default,bg=default,underscore'
setw -g window-status-bell-style 'fg=#f38ba8,bg=default,blink,bold'


# -- SSH detection -------------------------------------------------------------

# lower escape-time for local; higher for SSH (mobile latency)
if-shell '[ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]' \
  'set -sg escape-time 50' \
  'set -sg escape-time 10'

# fewer status refreshes over SSH
if-shell '[ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]' \
  'set -g status-interval 60' \
  'set -g status-interval 15'

# status bar position: top locally, bottom over SSH
if-shell '[ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]' \
  'set -g status-position bottom' \
  'set -g status-position top'


# -- plugins -------------------------------------------------------------------

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'Morantron/tmux-fingers'
set -g @fingers-key F

# Initialize tpm (must be last line)
run 'test -f ~/.config/tmux/plugins/tpm/tpm && ~/.config/tmux/plugins/tpm/tpm'
